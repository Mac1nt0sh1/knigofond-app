# Инструкция по деплою базы данных на NeonDB

## Шаг 1: Получение строки подключения из NeonDB

1. Откройте [NeonDB Dashboard](https://console.neon.tech/)
2. Войдите или создайте аккаунт
3. Создайте новый проект (если еще нет)
4. Выберите ваш проект
5. Перейдите в **Connection Details** или нажмите на название проекта
6. Найдите раздел **Connection string**

### Строка подключения:

NeonDB предоставляет одну строку подключения, которая работает для всего:
- Формат: `postgresql://[user]:[password]@[hostname]/[database]?sslmode=require`
- Пример: `postgresql://user:password@ep-cool-darkness-123456.us-east-2.aws.neon.tech/neondb?sslmode=require`

**Важно:** NeonDB автоматически управляет connection pooling, поэтому обычно нужна только одна строка подключения.

## Шаг 2: Настройка переменных окружения

### Локально (файл `.env`):

```env
# Основная строка подключения (для приложения и миграций)
DATABASE_URL="postgresql://[user]:[password]@[hostname]/[database]?sslmode=require"

# Direct connection (можно использовать ту же строку или оставить пустым)
DIRECT_URL="postgresql://[user]:[password]@[hostname]/[database]?sslmode=require"
```

**Примечание:** Для NeonDB обычно достаточно только `DATABASE_URL`. `DIRECT_URL` можно установить таким же или оставить пустым.

### На Vercel:

1. Откройте Vercel Dashboard → Ваш проект → **Settings** → **Environment Variables**
2. Добавьте переменные:
   - `DATABASE_URL` (основная строка подключения из NeonDB)
   - `DIRECT_URL` (можно использовать ту же строку или оставить пустым)

## Шаг 3: Деплой базы данных

### Вариант 1: Быстрый деплой (рекомендуется для первого раза)

Использует `prisma db push` - синхронизирует схему без создания миграций:

```bash
npm run db:push
```

Или напрямую:
```bash
npx prisma db push
```

**Преимущества:**
- Быстро и просто
- Автоматически создает/обновляет таблицы
- Не требует создания миграций

**Недостатки:**
- Не сохраняет историю изменений
- Может быть проблематично в команде

### Вариант 2: Деплой с миграциями (рекомендуется для продакшена)

#### 3.1. Создание первой миграции:

```bash
npx prisma migrate dev --name init
```

Это создаст:
- Папку `prisma/migrations/`
- SQL файлы миграций
- Применит изменения к базе данных

#### 3.2. Применение миграций на продакшене:

```bash
npx prisma migrate deploy
```

**Преимущества:**
- Сохраняет историю изменений
- Можно откатывать изменения
- Лучше для командной работы

## Шаг 4: Генерация Prisma Client

После деплоя схемы сгенерируйте Prisma Client:

```bash
npx prisma generate
```

Это создаст типизированный клиент для работы с базой данных.

## Шаг 5: (Опционально) Заполнение тестовыми данными

Если у вас есть seed файл:

```bash
npm run db:seed
```

Или:
```bash
npx tsx prisma/seed.ts
```

## Проверка деплоя

### Вариант 1: Prisma Studio (визуальный редактор)

```bash
npm run db:studio
```

Откроется браузер с интерфейсом для просмотра и редактирования данных.

### Вариант 2: NeonDB Dashboard

1. Откройте NeonDB Dashboard
2. Перейдите в ваш проект → **Tables**
3. Проверьте, что все таблицы созданы:
   - `User`
   - `Account`
   - `Session`
   - `VerificationToken`
   - `Book`
   - `ReadingGoal`

## Важные замечания

1. **NeonDB использует одну строку подключения** - она работает и для приложения, и для миграций
2. **Connection pooling встроен** - NeonDB автоматически управляет пулом подключений
3. **Не коммитьте `.env` файл** - он уже в `.gitignore`
4. **После изменения схемы** всегда запускайте `prisma generate`
5. **SSL обязателен** - убедитесь, что в строке подключения есть `?sslmode=require`

## Решение проблем

### Ошибка P1000: Authentication failed

**Основные причины:**
1. Неверный пароль в строке подключения
2. Специальные символы в пароле не закодированы в URL
3. Используется неправильная строка подключения

**Решение:**
1. Проверьте пароль в Supabase Dashboard → Settings → Database
2. Если пароль содержит специальные символы (@, #, $, %, &, +, =, ?, /, :, ;, пробел), закодируйте их:
   - `@` → `%40`
   - `#` → `%23`
   - `$` → `%24`
   - `%` → `%25`
   - `&` → `%26`
   - `+` → `%2B`
   - `=` → `%3D`
   - `?` → `%3F`
   - `/` → `%2F`
   - `:` → `%3A`
   - `;` → `%3B`
   - Пробел → `%20`
3. Убедитесь, что:
   - `DATABASE_URL` содержит `?sslmode=require`
   - Строка подключения правильного формата для NeonDB
4. Проверьте, что строка подключения скопирована полностью из NeonDB Dashboard

**Подробная инструкция:** См. файл `FIX_DB_CONNECTION.md`

### Ошибка подключения
- Проверьте правильность строки подключения из NeonDB Dashboard
- Убедитесь, что пароль закодирован, если содержит специальные символы
- Проверьте, что в строке подключения есть `?sslmode=require`
- Убедитесь, что проект в NeonDB активен и не приостановлен

### Ошибка при миграции
- Убедитесь, что используете `DIRECT_URL` для миграций
- Проверьте права доступа к базе данных
- Посмотрите логи в Supabase Dashboard

### Таблицы не создаются
- Проверьте, что `DATABASE_URL` и `DIRECT_URL` установлены правильно
- Убедитесь, что Prisma Client сгенерирован: `npx prisma generate`
- Проверьте логи выполнения команд

